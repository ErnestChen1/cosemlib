/*
 * test_cosem_read_by_block.cpp
 *
 *  Created on: 3 nov. 2017
 *      Author: anthony
 */

#include "os_util.h"
#include "hdlc.h"
#include "csm_axdr_codec.h"
#include "csm_array.h"
#include "JsonWriter.h"
#include "JsonValue.h"
#include "AxdrPrinter.h"

#include "catch.hpp"
#include <iostream>
#include <cstdlib>
#include <cstring>
#include <sstream>
#include <bitset>

const char profile_example[] = "008201F401020208090C07E0091C031111210000B4000408110221090C07E0091C031111210000B400020509060100010600FF060000000002020F00161B1100090C07D001010600000000000000020509060100020600FF060000000002020F00161B1100090C07D001010600000000000000020509060100030600FF060000000002020F00161D1100090C07D001010600000000000000020509060100040600FF060000000002020F00161D1100090C07D001010600000000000000020509060100050600FF060000000002020F00161D1100090C07D001010600000000000000020509060100080600FF060000000002020F00161D1100090C07D001010600000000000000020509060100090600FF060000000002020F00161C1100090C07D0010106000000000000000205090601000A0600FF060000000002020F00161C1100090C07D001010600000000000000020509060100010601FF060000000002020F00161B1100090C07D001010600000000000000020509060100020601FF060000000002020F00161B1100090C07D001010600000000000000020509060100030601FF060000000002020F00161D1100090C07D001010600000000000000020509060100040601FF060000000002020F00161D1100090C07D001010600000000000000020509060100050601FF060000000002020F00008201F4161D1100090C07D001010600000000000000020509060100080601FF060000000002020F00161D1100090C07D001010600000000000000020509060100090601FF060000000002020F00161C1100090C07D0010106000000000000000205090601000A0601FF060000000002020F00161C1100090C07D001010600000000000000020509060100010602FF060000000002020F00161B1100090C07D001010600000000000000020509060100020602FF060000000002020F00161B1100090C07D001010600000000000000020509060100030602FF060000000002020F00161D1100090C07D001010600000000000000020509060100040602FF060000000002020F00161D1100090C07D001010600000000000000020509060100050602FF060000000002020F00161D1100090C07D001010600000000000000020509060100080602FF060000000002020F00161D1100090C07D001010600000000000000020509060100090602FF060000000002020F00161C1100090C07D0010106000000000000000205090601000A0602FF060000000002020F00161C1100090C07D001010600000000000000020509060100010603FF060000000002020F00161B1100090C07D001010600000000000000020509060100020603FF060000000002020F00161B1100090C07D00101060000000000000002008201F40509060100030603FF060000000002020F00161D1100090C07D001010600000000000000020509060100040603FF060000000002020F00161D1100090C07D001010600000000000000020509060100050603FF060000000002020F00161D1100090C07D001010600000000000000020509060100080603FF060000000002020F00161D1100090C07D001010600000000000000020509060100090603FF060000000002020F00161C1100090C07D0010106000000000000000205090601000A0603FF060000000002020F00161C1100090C07D0010106000000000000000221090C07E0091C031111210000B400020309060100010200FF15000000000000000002020F00161B020309060100020200FF15000000000000000002020F00161B020309060100030200FF15000000000000000002020F00161D020309060100040200FF15000000000000000002020F00161D020309060100050200FF15000000000000000002020F00161D020309060100080200FF15000000000000000002020F00161D020309060100090200FF15000000000000000002020F00161C0203090601000A0200FF15000000000000000002020F00161C020309060100010201FF15000000000000000002020F00161B020309060100020201FF15000000000000000002020F00161B020309060100030201FF150000008201F400000000000002020F00161D020309060100040201FF15000000000000000002020F00161D020309060100050201FF15000000000000000002020F00161D020309060100080201FF15000000000000000002020F00161D020309060100090201FF15000000000000000002020F00161C0203090601000A0201FF15000000000000000002020F00161C020309060100010202FF15000000000000000002020F00161B020309060100020202FF15000000000000000002020F00161B020309060100030202FF15000000000000000002020F00161D020309060100040202FF15000000000000000002020F00161D020309060100050202FF15000000000000000002020F00161D020309060100080202FF15000000000000000002020F00161D020309060100090202FF15000000000000000002020F00161C0203090601000A0202FF15000000000000000002020F00161C020309060100010203FF15000000000000000002020F00161B020309060100020203FF15000000000000000002020F00161B020309060100030203FF15000000000000000002020F00161D020309060100040203FF15000000000000000002020F00161D020309060100050203FF15000000000000000002020F00161D020309060100080203FF15000000000000000002020F00161D020309060100090203FF150000008201F400000000000002020F00161C0203090601000A0203FF15000000000000000002020F00161C0247090C07E0091C031111210000B400040801020309060100010800FF15000000000000000002020F00161E020309060100020800FF15000000000000000002020F00161E020309060100030800FF15000000000000000002020F001620020309060100040800FF15000000000000000002020F001620020309060100050800FF15000000000000000002020F001620020309060100060800FF15000000000000000002020F001620020309060100070800FF15000000000000000002020F001620020309060100080800FF15000000000000000002020F001620020309060100090800FF15000000000000000002020F00161F0203090601000A0800FF15000000000000000002020F00161F0203090601000F0800FF15000000000000000002020F00161E0203090601000D0000FF06000003E802020FFD16FF020309060100150800FF15000000000000000002020F00161E020309060100160800FF15000000000000000002020F00161E020309060100170800FF15000000000000000002020F001620020309060100180800FF15000000000000000002020F001620020309060100190800FF15000000000000000002020F0016200203090601001A0800FF15000000000000000002020F00008201F416200203090601001B0800FF15000000000000000002020F0016200203090601001C0800FF15000000000000000002020F0016200203090601001D0800FF15000000000000000002020F00161F0203090601001E0800FF15000000000000000002020F00161F020309060100290800FF15000000000000000002020F00161E0203090601002A0800FF15000000000000000002020F00161E0203090601002B0800FF15000000000000000002020F0016200203090601002C0800FF15000000000000000002020F0016200203090601002D0800FF15000000000000000002020F0016200203090601002E0800FF15000000000000000002020F0016200203090601002F0800FF15000000000000000002020F001620020309060100300800FF15000000000000000002020F001620020309060100310800FF15000000000000000002020F00161F020309060100320800FF15000000000000000002020F00161F0203090601003D0800FF15000000000000000002020F00161E0203090601003E0800FF15000000000000000002020F00161E0203090601003F0800FF15000000000000000002020F001620020309060100400800FF15000000000000000002020F001620020309060100410800FF15000000000000000002020F001620020309060100420800FF15000000000000000002020F00008201F41620020309060100430800FF15000000000000000002020F001620020309060100440800FF15000000000000000002020F001620020309060100450800FF15000000000000000002020F00161F020309060100460800FF15000000000000000002020F00161F020309060100010801FF15000000000000000002020F00161E020309060100020801FF15000000000000000002020F00161E020309060100030801FF15000000000000000002020F001620020309060100040801FF15000000000000000002020F001620020309060100050801FF15000000000000000002020F001620020309060100080801FF15000000000000000002020F001620020309060100090801FF15000000000000000002020F00161F0203090601000A0801FF15000000000000000002020F00161F0203090601000D0001FF060000000002020FFD16FF020309060100010802FF15000000000000000002020F00161E020309060100020802FF15000000000000000002020F00161E020309060100030802FF15000000000000000002020F001620020309060100040802FF15000000000000000002020F001620020309060100050802FF15000000000000000002020F001620020309060100080802FF15000000000000000002020F001620020309060100090802FF15000000000000000002020F00161F020300820154090601000A0802FF15000000000000000002020F00161F0203090601000D0002FF06000003E802020FFD16FF020309060100010803FF15000000000000000002020F00161E020309060100020803FF15000000000000000002020F00161E020309060100030803FF15000000000000000002020F001620020309060100040803FF15000000000000000002020F001620020309060100050803FF15000000000000000002020F001620020309060100080803FF15000000000000000002020F001620020309060100090803FF15000000000000000002020F00161F0203090601000A0803FF15000000000000000002020F00161F0203090601000D0003FF060000000002020FFD16FF020309060100010900FF15000000000000000002020F00161E020309060100030900FF15000000000000000002020F001620020309060100090900FF15000000000000000002020F00161F008201F40208090C07E00A04020B1D080000B4000408130221090C07E00A04020B1D080000B400020509060100010600FF060000000102020F00161B1100090C07E0091C03111129008000FF020509060100020600FF060000000002020F00161B1100090C07E0091C031111210000B400020509060100030600FF060000000202020F00161D1100090C07E0091C03111129008000FF020509060100040600FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100050600FF060000000202020F00161D1100090C07E0091C03111129008000FF020509060100080600FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100090600FF060000000202020F00161C1100090C07E0091C03111129008000FF0205090601000A0600FF060000000002020F00161C1100090C07E0091C031111210000B400020509060100010601FF060000000002020F00161B1100090C07E0091C031111210000B400020509060100020601FF060000000002020F00161B1100090C07E0091C031111210000B400020509060100030601FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100040601FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100050601FF060000000002020F00161D008201F41100090C07E0091C031111210000B400020509060100080601FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100090601FF060000000002020F00161C1100090C07E0091C031111210000B4000205090601000A0601FF060000000002020F00161C1100090C07E0091C031111210000B400020509060100010602FF060000000102020F00161B1100090C07E0091C03111129008000FF020509060100020602FF060000000002020F00161B1100090C07E0091C031111210000B400020509060100030602FF060000000202020F00161D1100090C07E0091C03111129008000FF020509060100040602FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100050602FF060000000202020F00161D1100090C07E0091C03111129008000FF020509060100080602FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100090602FF060000000202020F00161C1100090C07E0091C03111129008000FF0205090601000A0602FF060000000002020F00161C1100090C07E0091C031111210000B400020509060100010603FF060000000002020F00161B1100090C07E0091C031111210000B400020509060100020603FF060000000002020F00161B1100090C07E0091C031111210000B400020509008201F4060100030603FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100040603FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100050603FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100080603FF060000000002020F00161D1100090C07E0091C031111210000B400020509060100090603FF060000000002020F00161C1100090C07E0091C031111210000B4000205090601000A0603FF060000000002020F00161C1100090C07E0091C031111210000B4000221090C07E00A04020B1D080000B400020309060100010200FF15000000000000000102020F00161B020309060100020200FF15000000000000000002020F00161B020309060100030200FF15000000000000000202020F00161D020309060100040200FF15000000000000000002020F00161D020309060100050200FF15000000000000000202020F00161D020309060100080200FF15000000000000000002020F00161D020309060100090200FF15000000000000000202020F00161C0203090601000A0200FF15000000000000000002020F00161C020309060100010201FF15000000000000000002020F00161B020309060100020201FF15000000000000000002020F00161B020309060100030201FF1500000000008201F40000000002020F00161D020309060100040201FF15000000000000000002020F00161D020309060100050201FF15000000000000000002020F00161D020309060100080201FF15000000000000000002020F00161D020309060100090201FF15000000000000000002020F00161C0203090601000A0201FF15000000000000000002020F00161C020309060100010202FF15000000000000000102020F00161B020309060100020202FF15000000000000000002020F00161B020309060100030202FF15000000000000000202020F00161D020309060100040202FF15000000000000000002020F00161D020309060100050202FF15000000000000000202020F00161D020309060100080202FF15000000000000000002020F00161D020309060100090202FF15000000000000000202020F00161C0203090601000A0202FF15000000000000000002020F00161C020309060100010203FF15000000000000000002020F00161B020309060100020203FF15000000000000000002020F00161B020309060100030203FF15000000000000000002020F00161D020309060100040203FF15000000000000000002020F00161D020309060100050203FF15000000000000000002020F00161D020309060100080203FF15000000000000000002020F00161D020309060100090203FF1500000000008201F40000000002020F00161C0203090601000A0203FF15000000000000000002020F00161C0247090C07E00A04020B1D080000B400040803020309060100010800FF15000000000000000102020F00161E020309060100020800FF15000000000000000002020F00161E020309060100030800FF15000000000000000102020F001620020309060100040800FF15000000000000000002020F001620020309060100050800FF15000000000000000102020F001620020309060100060800FF15000000000000000002020F001620020309060100070800FF15000000000000000002020F001620020309060100080800FF15000000000000000002020F001620020309060100090800FF15000000000000000102020F00161F0203090601000A0800FF15000000000000000002020F00161F0203090601000F0800FF15000000000000000102020F00161E0203090601000D0000FF060000039402020FFD16FF020309060100150800FF15000000000000000002020F00161E020309060100160800FF15000000000000000002020F00161E020309060100170800FF15000000000000000002020F001620020309060100180800FF15000000000000000002020F001620020309060100190800FF15000000000000000002020F0016200203090601001A0800FF15000000000000000002020F001620008201F40203090601001B0800FF15000000000000000002020F0016200203090601001C0800FF15000000000000000002020F0016200203090601001D0800FF15000000000000000002020F00161F0203090601001E0800FF15000000000000000002020F00161F020309060100290800FF15000000000000000002020F00161E0203090601002A0800FF15000000000000000002020F00161E0203090601002B0800FF15000000000000000002020F0016200203090601002C0800FF15000000000000000002020F0016200203090601002D0800FF15000000000000000002020F0016200203090601002E0800FF15000000000000000002020F0016200203090601002F0800FF15000000000000000002020F001620020309060100300800FF15000000000000000002020F001620020309060100310800FF15000000000000000002020F00161F020309060100320800FF15000000000000000002020F00161F0203090601003D0800FF15000000000000000002020F00161E0203090601003E0800FF15000000000000000002020F00161E0203090601003F0800FF15000000000000000002020F001620020309060100400800FF15000000000000000002020F001620020309060100410800FF15000000000000000002020F001620020309060100420800FF15000000000000000002020F001620008201F4020309060100430800FF15000000000000000002020F001620020309060100440800FF15000000000000000002020F001620020309060100450800FF15000000000000000002020F00161F020309060100460800FF15000000000000000002020F00161F020309060100010801FF15000000000000000002020F00161E020309060100020801FF15000000000000000002020F00161E020309060100030801FF15000000000000000002020F001620020309060100040801FF15000000000000000002020F001620020309060100050801FF15000000000000000002020F001620020309060100080801FF15000000000000000002020F001620020309060100090801FF15000000000000000002020F00161F0203090601000A0801FF15000000000000000002020F00161F0203090601000D0001FF060000000002020FFD16FF020309060100010802FF15000000000000000102020F00161E020309060100020802FF15000000000000000002020F00161E020309060100030802FF15000000000000000102020F001620020309060100040802FF15000000000000000002020F001620020309060100050802FF15000000000000000102020F001620020309060100080802FF15000000000000000002020F001620020309060100090802FF15000000000000000102020F00161F020309060082015201000A0802FF15000000000000000002020F00161F0203090601000D0002FF060000039402020FFD16FF020309060100010803FF15000000000000000002020F00161E020309060100020803FF15000000000000000002020F00161E020309060100030803FF15000000000000000002020F001620020309060100040803FF15000000000000000002020F001620020309060100050803FF15000000000000000002020F001620020309060100080803FF15000000000000000002020F001620020309060100090803FF15000000000000000002020F00161F0203090601000A0803FF15000000000000000002020F00161F0203090601000D0003FF060000000002020FFD16FF020309060100010900FF15000000000000000002020F00161E020309060100030900FF15000000000000000002020F001620020309060100090900FF15000000000000000002020F00161F";

int profile_size = sizeof(profile_example);

static AxdrPrinter gPrinter;

static void AxdrData(uint8_t type, uint32_t size, uint8_t *data)
{
    gPrinter.Append(type, size, data);
}


void TestBigBlockProfile()
{
    // transform the hexadecimal string into an array of integers
    size_t packet_size = profile_size/2U;
    uint8_t *packet = (uint8_t *) malloc(packet_size);

    if (packet != NULL)
    {
        int ret;
        uint8_t *packet_ptr = packet;

        hex2bin(profile_example, (char *)packet, profile_size);

        csm_array array;
        csm_array_init(&array, packet, packet_size, packet_size, 0);
        uint32_t size = 0U;
        csm_axdr_decode_block(&array, &size);

        printf("Profile size: %d\r\n", size); // must be 500

    //    root.Clear();

        csm_axdr_decode_tags(&array, AxdrData);

        std::cout << gPrinter.Get() << std::endl;

        free(packet);
    }
    else
    {
       printf("Cannot allocate memory!\r\n");
    }

}


TEST_CASE( "COSEM_READ", "[Read by block]" )
{
    puts("\r\n--------------------------  COSEM TEST READ 1  --------------------------\r\n");
    TestBigBlockProfile();
}


